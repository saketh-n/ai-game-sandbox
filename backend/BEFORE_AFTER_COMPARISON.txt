COLLECTIBLE SEGMENTATION: BEFORE vs AFTER
==========================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           BEFORE (BROKEN)                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Input: collectible_sprite_sheet.png (white background)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ğŸª™  ğŸ’  â­  ğŸ”‘  â¤ï¸                      â”‚ (on white bg)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Load image directly
  âœ— No Claude Vision analysis
  âœ— No layout detection
  âœ— Guessing how many sprites exist

Step 2: Connected component analysis on ORIGINAL image
  alpha = np.array(sprite_sheet)[:, :, 3]
  content_mask = alpha > 10
  labeled_array, num_components = ndimage.label(content_mask)
  
  Problem: White background NOT REMOVED!
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ                    â”‚
  â”‚  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â† Includes white â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  Result: Might detect white pixels as part of sprites
          Bounding boxes too large
          Inconsistent sprite sizes

Step 3: Raw crop and convert to base64
  âœ— No centering
  âœ— No normalization
  âœ— Variable sprite dimensions

Output: Array of improperly segmented sprites
  [ "data:...", "data:...", ... ]  â† May include background artifacts


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                            AFTER (FIXED)                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Input: collectible_sprite_sheet.png (white background)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ğŸª™  ğŸ’  â­  ğŸ”‘  â¤ï¸                      â”‚ (on white bg)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Claude Vision Analysis (SpriteSheetAnalyzer)
  âœ“ Analyzes layout automatically
  âœ“ Detects: horizontal layout, 1 row Ã— 5 columns
  âœ“ Estimates frame dimensions: 64Ã—64px each
  
  Result:
  {
    "layout_type": "horizontal",
    "rows": 1,
    "columns": 5,
    "total_frames": 5,
    "frame_width": 64,
    "frame_height": 64
  }

Step 2: Background Removal (BackgroundRemover)
  âœ“ Remove white background (tolerance=40)
  âœ“ Auto-crop excess transparent space
  
  Before removal:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ğŸª™  ğŸ’  â­  ğŸ”‘  â¤ï¸                      â”‚ (white bg)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  After removal:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ğŸª™  ğŸ’  â­  ğŸ”‘  â¤ï¸                      â”‚ (transparent)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: Smart Frame Extraction (extract_frames_smart)
  âœ“ Connected component analysis on CLEANED image
  âœ“ Uses _extract_horizontal_with_gaps()
  âœ“ Detects actual content bounds (no white pixels)
  
  alpha = np.array(cleaned_sprite_sheet)[:, :, 3]
  content_mask = alpha > 10
  labeled_array, num_components = ndimage.label(content_mask)
  
  Detects pure sprite boundaries:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ [ğŸª™][ğŸ’][â­][ğŸ”‘][â¤ï¸]                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘    â†‘    â†‘    â†‘    â†‘
  Component 1-5 with tight bounding boxes

Step 4: Frame Processing
  âœ“ Extract bounding box for each component
  âœ“ Sort left-to-right
  âœ“ Filter noise (< 1% of largest sprite)
  âœ“ Center on consistent canvas (max_width Ã— max_height)
  
  Frame 0: ğŸª™ â†’ centered on 64Ã—64 canvas
  Frame 1: ğŸ’ â†’ centered on 64Ã—64 canvas
  Frame 2: â­ â†’ centered on 64Ã—64 canvas
  Frame 3: ğŸ”‘ â†’ centered on 64Ã—64 canvas
  Frame 4: â¤ï¸ â†’ centered on 64Ã—64 canvas

Step 5: Convert to Base64
  âœ“ Each frame saved as PNG
  âœ“ Encoded as data URL
  
Output: Array of properly segmented, clean sprites
  [
    "data:image/png;base64,iVBORw0KGgo...",  // ğŸª™
    "data:image/png;base64,iVBORw0KGgo...",  // ğŸ’
    "data:image/png;base64,iVBORw0KGgo...",  // â­
    "data:image/png;base64,iVBORw0KGgo...",  // ğŸ”‘
    "data:image/png;base64,iVBORw0KGgo..."   // â¤ï¸
  ]


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         KEY DIFFERENCES                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature              â”‚ BEFORE (Broken)     â”‚ AFTER (Fixed)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layout Analysis      â”‚ âŒ None             â”‚ âœ… Claude Vision         â”‚
â”‚ Background Removal   â”‚ âŒ No               â”‚ âœ… Yes (tolerance=40)    â”‚
â”‚ Frame Detection      â”‚ âŒ Raw CC analysis  â”‚ âœ… Smart extraction      â”‚
â”‚ Frame Centering      â”‚ âŒ No               â”‚ âœ… Centered on canvas    â”‚
â”‚ Noise Filtering      â”‚ âš ï¸  Basic          â”‚ âœ… Advanced (1% thresh)  â”‚
â”‚ Consistent with Char â”‚ âŒ Different logic  â”‚ âœ… Same pipeline         â”‚
â”‚ Sprite Quality       â”‚ âš ï¸  May have bg     â”‚ âœ… Clean, transparent    â”‚
â”‚ Frame Dimensions     â”‚ âŒ Variable         â”‚ âœ… Normalized            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        CODE COMPARISON                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEFORE:
-------
def segment_collectible_sprites(collectible_path: Path) -> List[str]:
    sprite_sheet = Image.open(collectible_path).convert('RGBA')
    alpha = np.array(sprite_sheet)[:, :, 3]
    content_mask = alpha > 10
    labeled_array, num_components = ndimage.label(content_mask)
    # ... extract bounding boxes ...
    # ... convert to base64 ...
    return sprite_data_urls

AFTER:
------
def segment_collectible_sprites(
    collectible_path: Path,
    sprite_analyzer: SpriteSheetAnalyzer  â† Uses analyzer
) -> List[str]:
    # Step 1: Analyze with Claude Vision
    layout_info = sprite_analyzer.analyze_sprite_sheet_layout(collectible_path)
    
    # Step 2: Remove background
    bg_remover = BackgroundRemover()
    cleaned_img = bg_remover.remove_background(original_img, ...)
    cleaned_img = bg_remover.auto_crop(cleaned_img)
    
    # Step 3: Smart extraction (handles gaps, centering, etc.)
    frames, w, h = sprite_analyzer.extract_frames_smart(
        cleaned_path, rows=layout_info['rows'], columns=layout_info['columns']
    )
    
    # Step 4: Convert each frame to base64
    for frame in frames:
        buffer = io.BytesIO()
        frame.save(buffer, format='PNG')
        sprite_data_urls.append(f"data:image/png;base64,{...}")
    
    return sprite_data_urls


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     IN-GAME RESULT                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEFORE:
-------
// Phaser loads sprites
collectibleSprites = ["data:...", "data:...", ...];  // May have white bg
this.textures.addImage('collectible_0', sprite0);

// Spawns in game
Platform: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              ğŸª™â¬œ          â† White background visible!
              â†‘
          Collectible has white box around it


AFTER:
------
// Phaser loads clean sprites
collectibleSprites = ["data:...", "data:...", ...];  // Pure transparent bg
this.textures.addImage('collectible_0', sprite0);

// Spawns in game
Platform: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              ğŸª™            â† Clean sprite, no artifacts!
              â†‘
          Collectible perfectly transparent


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         SUMMARY                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

The fix ensures collectible sprites go through the EXACT SAME PIPELINE as
character sprites:

1. âœ… Claude Vision analyzes layout
2. âœ… Background removal cleans image
3. âœ… Smart extraction finds actual content bounds
4. âœ… Frames centered and normalized
5. âœ… Clean, professional-looking sprites in game

Result: Collectibles look as good as character sprites, with proper
        transparency and consistent dimensions!

